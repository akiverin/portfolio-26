---
description: 'FSD architecture adapted for Next.js App Router — layers, dependencies, file structure'
globs: ['src/**/*.ts', 'src/**/*.tsx']
alwaysApply: false
---

# Architecture — Feature-Sliced Design (FSD) for Next.js

## Layer Hierarchy (top → bottom)

```
app/        → Next.js App Router: routing, layouts, providers (replaces FSD app + pages)
widgets/    → Composite blocks reused across pages (Header, Footer, sections)
features/   → User actions (auth forms, theme toggle)
entities/   → Business entities (Project, Achievement, Grant, User)
shared/     → Reusable code without business logic
```

**Note**: In Next.js App Router, the `app/` directory handles both initialization and routing.
There is no separate `pages/` layer — Next.js file-based routing replaces it.

## Import Rules

**Each layer may only import from layers BELOW it.**

| Layer      | Can import from                         |
| ---------- | --------------------------------------- |
| `app`      | widgets, features, entities, shared     |
| `widgets`  | features, entities, shared              |
| `features` | entities, shared                        |
| `entities` | entities (cross-import allowed), shared |
| `shared`   | nothing above — only external packages  |

```typescript
// ❌ DON'T — widget importing from app
import { HomePage } from '@/app/page';

// ❌ DON'T — feature importing from widget
import { Header } from 'widgets/Header/ui/Header';

// ✅ DO — widget importing from entity
import { ProjectCard } from 'entities/Project/ui/ProjectCard';
```

## Placement Decision

**Key question**: Will this code be used on multiple pages?

- **No, it's page-specific** → Keep it in `app/` route directory
- **Yes, it's a composite visual block** → `widgets/`
- **Yes, it's a user action/interaction** → `features/`
- **Yes, it's an entity representation** → `entities/`
- **Yes, it's generic utility** → `shared/`

## Slice Structure

```
SliceName/
├── ui/                       # React components
│   └── ComponentName/
│       ├── ComponentName.tsx
│       ├── ComponentName.module.scss
│       └── index.ts
├── model/                    # MobX stores, types
│   ├── types.ts
│   └── EntityModel.ts
├── api/                      # API calls (entities only)
│   └── getEntity.ts
├── stores/                   # MobX stores
│   └── EntityListStore.ts
└── hooks/                    # Slice-specific hooks
```

## Public API — Module-Level Exports

Export via `index.ts` at the module level, NOT at segment level:

```typescript
// ✅ DO — module-level index.ts
// entities/Project/ui/ProjectCard/index.ts
export { default } from './ProjectCard';

// ❌ DON'T — segment-level barrel aggregating multiple modules
// entities/Project/ui/index.ts
export * from './ProjectCard';
export * from './ProjectDetails';
```

## Next.js App Router Patterns

### Server vs Client Components

By default, components in `app/` are Server Components. Add `"use client"` only when needed:

```typescript
// Needs "use client" when:
// - Using hooks (useState, useEffect, useContext)
// - Using MobX observer()
// - Using browser APIs
// - Handling events (onClick, onChange, etc.)

'use client';
import { observer } from 'mobx-react-lite';
```

### Page Structure

Pages in `app/` compose widgets and features:

```typescript
// app/page.tsx — Server Component, no "use client" needed
import HeroSection from 'widgets/HeroSection/ui/HeroSection';
import ProjectsSection from 'widgets/ProjectsSection/ui/ProjectsSection';

export default function HomePage() {
  return (
    <main>
      <HeroSection />
      <ProjectsSection />
    </main>
  );
}
```

### Layouts

Global providers go in `app/layout.tsx`:

```typescript
import { MantineProvider } from '@mantine/core';
import { StoreProvider } from 'shared/stores/StoreContext';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <MantineProvider>
          <StoreProvider>
            {children}
          </StoreProvider>
        </MantineProvider>
      </body>
    </html>
  );
}
```
