---
description: 'React + MobX patterns — stores, observer, useLocalStore, context injection'
globs: ['src/**/*.tsx', 'src/**/*.ts']
alwaysApply: false
---

# React + MobX Patterns

## Store Lifecycle — ILocalStore

Every store that needs cleanup MUST implement `ILocalStore`:

```typescript
import { ILocalStore } from 'shared/types/ILocalStore';
import { IReactionDisposer, makeObservable, computed, action, reaction } from 'mobx';

export class MyStore implements ILocalStore {
  private readonly _disposers: IReactionDisposer[] = [];

  constructor() {
    makeObservable(this, {
      someComputed: computed,
      someAction: action.bound,
    });

    this._disposers.push(
      reaction(
        () => this.filter,
        () => this.load(),
      ),
    );
  }

  destroy(): void {
    this._disposers.forEach((d) => d());
  }
}
```

## useLocalStore — Creating Stores in Components

**CRITICAL**: Import from `shared/hooks/useLocalStore`, NOT from `mobx-react-lite`.

```typescript
import { useLocalStore } from 'shared/hooks/useLocalStore';

const MyComponent: React.FC = () => {
  const store = useLocalStore(() => new MyStore());
  // store.destroy() is called automatically on unmount
};
```

## observer() — When and How

**CRITICAL**: Every component reading MobX observables MUST be wrapped with `observer()`.

```typescript
import { observer } from 'mobx-react-lite';

const ProjectCard: React.FC<Props> = ({ project }) => {
  return <div>{project.title}</div>;
};

export default observer(ProjectCard);
```

## Component Props Pattern

Props are typed as interfaces/types. Stores are passed as props or accessed via context:

```typescript
type ProjectCardProps = {
  project: Project;
  onAction?: () => void;
};

const ProjectCard: React.FC<ProjectCardProps> = ({ project, onAction }) => {
  // ...
};

export default observer(ProjectCard);
```

## Store Composition

Stores orchestrate child stores — they don't inherit, they compose:

```typescript
export class ProjectsPageStore implements ILocalStore {
  readonly projectList = new ProjectListStore();

  destroy(): void {
    this.projectList.destroy();
  }
}
```

## BaseStore for Loading States

```typescript
import { BaseStore } from 'shared/stores/BaseStore';

export class MyStore extends BaseStore implements ILocalStore {
  async load(): Promise<void> {
    this.setLoading();
    try {
      const data = await fetchData();
      runInAction(() => {
        this._data = data;
      });
      this.setSuccess();
    } catch (e) {
      this.setError(e);
    }
  }

  destroy(): void {
    // cleanup
  }
}
```

## Next.js + MobX Integration

### "use client" Directive

MobX stores and `observer()` components require `"use client"`:

```typescript
'use client';

import { observer } from 'mobx-react-lite';
import { useLocalStore } from 'shared/hooks/useLocalStore';
```

### Root Store via Context

Global stores (e.g., `UserStore`) are provided via React context in `layout.tsx`:

```typescript
// shared/stores/StoreContext.tsx
"use client";

import { createContext, useContext, useEffect, useRef } from 'react';
import { RootStore, initRootStore } from './RootStore';

const StoreContext = createContext<RootStore | null>(null);

export const StoreProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const storeRef = useRef<RootStore | null>(null);
  storeRef.current ??= initRootStore();

  useEffect(() => {
    storeRef.current?.userStore.initAuthListener();
    return () => storeRef.current?.userStore.destroy();
  }, []);

  return <StoreContext.Provider value={storeRef.current}>{children}</StoreContext.Provider>;
};

export const useRootStore = () => {
  const store = useContext(StoreContext);
  if (!store) throw new Error('useRootStore must be used within StoreProvider');
  return store;
};
```

## DON'T

- Don't use `useState`/`useReducer` for complex state — use MobX stores
- Don't mutate observables outside `action` or `runInAction`
- Don't forget `destroy()` — memory leaks from reactions/intervals
- Don't access store fields without `observer()` wrapper — reactivity won't work
- Don't use `useLocalObservable` from `mobx-react-lite` — use project's `useLocalStore`
