---
description: 'Performance — Next.js optimizations, tree-shaking, MobX optimization'
globs: ['src/**/*.ts', 'src/**/*.tsx']
alwaysApply: false
---

# Performance & Optimization

## Next.js Code Splitting

Next.js App Router automatically code-splits by route. No manual `React.lazy()` needed.

Use `next/dynamic` for heavy client components:

```typescript
import dynamic from 'next/dynamic';

const HeavyChart = dynamic(() => import('widgets/Chart/ui/Chart'), {
  ssr: false,
  loading: () => <Loader />,
});
```

## Server vs Client Components

Prefer Server Components (default in App Router) when possible:

- No interactivity needed
- No MobX stores
- No browser APIs
- Data fetching at build/request time

Use `"use client"` only for:

- Components with `observer()`, hooks, or event handlers
- Components using browser APIs

## No Barrel Files at Segment Level

**CRITICAL**: Barrel files that aggregate multiple modules break tree-shaking.

```typescript
// ❌ DON'T
// widgets/index.ts
export * from './Header';
export * from './Footer';

// ✅ DO — import directly
import Header from 'widgets/Header/ui/Header';
import Footer from 'widgets/Footer/ui/Footer';
```

## MobX Computed Values

Use `computed` for derived data — MobX caches results:

```typescript
makeObservable(this, {
  filteredProjects: computed,
});

get filteredProjects(): Project[] {
  return this._projects.filter(p => p.title.includes(this._filter));
}
```

## Image Optimization

Use `next/image` for all images:

```tsx
import Image from 'next/image';

<Image src={heroBg} alt="hero" width={3000} height={1930} quality={100} />;
```

## DON'T

- Don't create segment-level barrels — they prevent tree-shaking
- Don't run expensive computations in render — move to MobX `computed`
- Don't use `"use client"` unnecessarily — prefer Server Components
- Don't import heavy libraries in Server Components
